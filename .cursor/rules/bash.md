# Bash Script Rules

このファイルは、プロジェクトで配布・実行する Bash スクリプトに対する必須ルールです。
スクリプトは人間・CI・Agent によって実行されるため、安全性・再現性・可読性を最優先にします。

## 基本方針
- スクリプトは可能な限り **idempotent（再実行可能）** にする。
- 破壊的操作（リモート push・ファイル削除等）はデフォルトで無効とし、明示的フラグで有効化する。
- `--dry-run` と `--help` を必ず実装する。
- コマンド依存（git, gh, jq 等）は実行前にチェックし、明確なエラーメッセージを出す。

## 推奨シェル設定
スクリプト冒頭に次を必ず入れる：
```bash
#!/usr/bin/env bash
set -euo pipefail
IFS=$'\n\t'
```
また trap で一時ファイルを確実に削除する。

## オプションと引数
- 推奨するオプション例：--help, --dry-run, --auto, --commit-cmd, --json
- 引数パースは getopts または明示的ループで安全に行う（eval 禁止）。

## エラーコード
- 正常終了: 0
- 致命的エラー: 1
- ユーザー中断／安全チェックでの停止: 2

## ロギング
- log, warn, err の小関数を用意すること
- 人間向けログに加え、--json オプションでマシン向け出力を可能にすること

## 一時ファイル
- mktemp -d/mktemp を使う
- trap 'rm -rf "$TMPDIR"' EXIT を設定する

## セキュリティチェック
- 差分に対してシークレットパターンを検索する（password|secret|token|private_key|AKIA|aws_access 等）
- シークレットを検出したら必ず中断する（自動モードでも停止）

## 再現性と副作用の制御
- スクリプトは再実行可能であること。途中失敗しても状態を壊さない。
- 破壊的操作を行う場合は明示的フラグ（--confirm-push 等）を要求する。

## ツールとテスト
- shellcheck を CI で必須にすること
- 主要パスは bats 等で単体テストすること
- CI で --dry-run を常に実行すること

## Git 連携に関する注意
- push 操作は、--confirm-push または --auto の明示が無い限り行わない（運用ポリシーに応じて調整）
